# 三源一致性验证逻辑

## 🎯 核心原则

**不是平均，是一致性验证！**

```
❌ 错误: 三个源取平均
✅ 正确: 至少2个源一致才使用
```

---

## 📐 一致性定义

### 误差容忍度

| 字段 | 容忍度 | 示例 |
|------|--------|------|
| **价格** | ±5% | 100 vs 105 → ✅ 一致 |
| **PE** | ±10% | 20 vs 22 → ✅ 一致 |
| **PEG** | ±15% | 1.0 vs 1.1 → ✅ 一致 |

### 一致性判断

```python
相对误差 = |v1 - v2| / avg(v1, v2)

if 相对误差 <= 容忍度:
    ✅ 一致
else:
    ❌ 不一致
```

---

## 🔄 验证流程

### Step 1: 获取三个源

```
yfinance  → data1
finnhub   → data2  
twelvedata/akshare → data3
```

### Step 2: 比较一致性

```
价格比较:
  data1.price vs data2.price → 一致?
  data1.price vs data3.price → 一致?
  data2.price vs data3.price → 一致?

结果:
  - 有 ≥1 对一致 → ✅ 价格可信
  - 0 对一致 → ❌ 价格不可信
```

### Step 3: 决策

```
场景1: 3个源都成功，且至少2个一致
  → ✅ 使用一致的值

场景2: 3个源都成功，但都不一致
  → ❌ 拒绝数据

场景3: 只有2个源成功，且一致
  → ✅ 使用这2个源的值

场景4: 只有2个源成功，但不一致
  → ❌ 拒绝数据

场景5: 只有1个源成功
  → ❌ 拒绝数据
```

---

## 💡 示例

### 示例1: 三源一致 ✅

```
腾讯 (00700.HK):
  yfinance:   price=350.00, PE=20.5
  twelvedata: price=352.00, PE=21.0
  akshare:    price=348.00, PE=20.8

验证:
  价格: 350 vs 352 vs 348
    → 350 vs 352: 误差 0.57% < 5% ✅
    → 350 vs 348: 误差 0.57% < 5% ✅
    → 结论: 一致

  PE: 20.5 vs 21.0 vs 20.8
    → 20.5 vs 21.0: 误差 2.4% < 10% ✅
    → 20.5 vs 20.8: 误差 1.5% < 10% ✅
    → 结论: 一致

最终:
  ✅ 使用平均值
  price = 350.00
  PE = 20.77
```

### 示例2: 三源不一致 ❌

```
某股票:
  yfinance:   price=100.00
  finnhub:    price=150.00
  twelvedata: price=120.00

验证:
  100 vs 150: 误差 40% > 5% ❌
  100 vs 120: 误差 18% > 5% ❌
  150 vs 120: 误差 22% > 5% ❌

结论:
  ❌ 全部不一致 → 拒绝数据
```

### 示例3: 只有一个源 ❌

```
港股（finnhub不支持）:
  yfinance:   price=200.00 ✅
  finnhub:    失败 ❌
  twelvedata: 失败 ❌

结论:
  ❌ 只有1个源 → 拒绝数据
```

---

## 🎯 预期结果

### 美股七姐妹

```
yfinance ✅ + finnhub ✅ + twelvedata ✅
→ 3个源 → 高置信度
→ 预期: 7/7 条数据
```

### 港股七姐妹

```
yfinance ✅ + finnhub ❌ + twelvedata ✅
→ 2个源 → 中等置信度
→ 预期: 4-7/7 条数据（取决于twelvedata成功率）
```

### 总计

```
预期: 11-14 条数据
要求: 每条数据都有至少2个源一致验证
```

---

## ✅ 关键点

1. **不求平均** → 验证一致性
2. **至少2个源** → 才可信
3. **误差容忍** → 5%-15%合理
4. **严格拒绝** → 单源或不一致都拒绝
5. **可追溯** → data_source字段记录来源

