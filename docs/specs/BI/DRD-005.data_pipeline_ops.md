# DRD-005: 数据流水线运营规范

> 对应 BRN-005.schema.md (股票知识图谱数据运营)

## 1. 核心理念：字段白名单 + 透传

```
原始 Response (完整)
        │
        ├──▶ 白名单字段 ──▶ 校验流程 ──▶ 审核 ──▶ Neo4j
        │
        └──▶ 非白名单字段 ──────────────────────▶ Neo4j (直接写入)
```

**设计哲学**：
- ✅ 只校验业务关键字段（白名单）
- ✅ 其他字段透传，保留数据完整性
- ✅ 原始响应归档在 Django，便于追溯

## 2. 字段白名单定义

### 2.1 Company 白名单

| 字段 | 必填 | 校验规则 | 说明 |
|------|------|----------|------|
| `ticker` | ✅ | `^[A-Z]{1,5}$` | 唯一标识 |
| `name` | ✅ | 非空 | 公司名称 |
| `exchange` | | enum | NASDAQ/NYSE/... |
| `sector` | | 非空 | 行业分类 |

**透传字段示例**: description, website, employees, founded, ...

### 2.2 DailyQuote 白名单

| 字段 | 必填 | 校验规则 | 说明 |
|------|------|----------|------|
| `ticker` | ✅ | 关联 Company | |
| `date` | ✅ | ISO 8601 | |
| `close` | ✅ | > 0 | 收盘价 |
| `volume` | | >= 0 | 成交量 |

**透传字段示例**: open, high, low, adj_close, dividends, splits, ...

### 2.3 EarningsReport 白名单

| 字段 | 必填 | 校验规则 | 说明 |
|------|------|----------|------|
| `ticker` | ✅ | 关联 Company | |
| `fiscal_period` | ✅ | `^\d{4}Q[1-4]$` | 如 2024Q1 |
| `eps` | | 数值 | 每股收益 |
| `revenue` | | >= 0 | 营收 |

**透传字段示例**: net_income, operating_income, gross_profit, ...

### 2.4 NewsArticle 白名单

| 字段 | 必填 | 校验规则 | 说明 |
|------|------|----------|------|
| `article_id` | ✅ | 唯一 | |
| `title` | ✅ | 非空 | |
| `published_at` | | datetime | |

**透传字段示例**: content, summary, author, source, tags, sentiment, ...

## 3. 数据存储分层

| 存储位置 | 内容 | 用途 |
|----------|------|------|
| PostgreSQL | 完整原始 Response | 归档、追溯、调试 |
| Neo4j | 白名单字段 (校验后) | 业务查询 |
| Neo4j | 非白名单字段 (透传) | 扩展查询 |

## 4. 数据源配置

| 源 | 类型 | 数据类型 | 更新频率 |
|----|------|----------|----------|
| yfinance | API | Quote, Company | 日/实时 |
| SEC EDGAR | 爬虫 | Earnings | 季度 |
| Yahoo News | RSS | News | 实时 |

## 5. 流水线 SLA

| 指标 | 阈值 | 说明 |
|------|------|------|
| 日线数据新鲜度 | T+1 9:00 | 美股收盘后次日 |
| SP500 覆盖率 | ≥ 99% | 股价数据 |
| 白名单校验错误率 | ≤ 1% | 超限人工介入 |

## 6. 监控告警

| 告警 | 条件 | 级别 |
|------|------|------|
| 数据过期 | 超过 24h 无更新 | P2 |
| 覆盖率下降 | < 95% | P1 |
| 审核积压 | > 50 批次 | P2 |

## 7. 成本估算

| 组件 | 规模 | 月成本 |
|------|------|--------|
| Neo4j AuraDB | ~15M 节点 | ~$500 |
| PostgreSQL | ~50GB/年 | ~$20 |
| 人力审核 | ~5h/周 | - |

---

**状态**: 📋 待确认
