# TRD-002: 协议与通信约束（对应 BRN-002）
1) 协议：统一使用 GraphQL 作为数据契约（SDL in `libs/schema/schema.graphql`），HTTP/JSON 封装，保留未来 gRPC 扩展口。
2) SSOT：`libs/schema/schema.graphql` 为唯一源，前端/后端/回归共享，禁止绕过 Schema 传递 ad-hoc JSON。
3) 传输：HTTPS，Query/Mutation 携带必要参数（如 `symbol`）；响应为 GraphQL JSON。
4) 兼容：Schema 采用新增字段优先，破坏性变更需灰度/双写；利用 `@deprecated` 做废弃提示。
5) 依赖：后端集成 Ariadne + Flask；前端用 fetch/Apollo/TanStack Query；回归脚本使用 GraphQL Client。
6) 健康：`/graphql` 暴露 `ping` 查询返回 200 + 版本/时间戳；`/health` 可选组件状态。
7) 安全与缓存：信任一层代理，校验 `X-Forwarded-*`；Query 可选持久化，Mutation 不缓存；鉴权/限流在反代或后端 Context。
8) 监控：GraphQL `errors` 需打点，日志入 `x-log/`；异常请求记录 Query 摘要（脱敏）。
9) 发布：上线前跑 `backend:test` 与 `regression:*`；破坏性变更需回滚方案。
