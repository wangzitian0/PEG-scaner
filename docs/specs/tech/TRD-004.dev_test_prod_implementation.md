# TRD-004: 开发/测试/生产环境技术实现

> 对应 [BRN-004](../../origin/BRN-004.dev_test_prod_design.md)

## 1. 环境变量体系

| 环境 | PEG_ENV | DB_TABLE_PREFIX | 说明 |
|------|---------|-----------------|------|
| dev | development | dev_ | 本地开发 |
| ci | test | test_ | CI 测试 |
| test | test | test_ | PR 预览 |
| staging | staging | staging_ | 预发布 |
| prod | production | prod_ | 生产 |

**关键变量**：
- `PEG_ENV` → 控制 DEBUG 开关
- `DB_TABLE_PREFIX` → Neo4j Label 前缀隔离
- `NEO4J_URI/USER/PASSWORD` → 数据库连接

## 2. 数据隔离策略

### Label 前缀（已实现）
```python
# libs/neo4j_repo/connection.py
settings.prefixed_label("Company")
# dev: dev_Company, prod: prod_Company
```

**风险缓解**：Repository 层封装 + 单元测试校验

## 3. Docker Compose 结构

| 文件 | 用途 | 位置 |
|------|------|------|
| `docker-compose.yml` | 生产部署 | 根目录 |
| `docker-compose.dev.yml` | 本地开发 | 根目录 |
| `docker-compose.infra.yml` | CI 基础设施 | tools/docker/ |

## 4. 热更新机制

| 组件 | 方式 | 延迟 |
|------|------|------|
| Backend | uvicorn --reload | <2s |
| Frontend | Vite HMR | <1s |
| Codegen | npm run codegen:watch | 按需 |

## 5. tools/ 目录规范

### 目标结构
```
tools/
├── envs/           # 环境变量 (env.ci, env.example)
├── docker/         # Docker 相关
├── scripts/        # 自动化脚本 (dev.sh, init_db.sh)
├── ci/             # CI 专用 (test-ci.sh, lint_structure.sh)
├── bin/            # 可执行文件
├── manage.py       # CLI 入口
└── README.md
```

### 设计原则
- **按职能分目录**，不按环境分
- **SSOT**：同类文件只有一个位置
- **根目录保留**：Dokploy/CI 直接读取的文件

### 迁移计划
| 当前 | 目标 |
|------|------|
| tools/dev.sh | tools/scripts/dev.sh |
| tools/init_db.sh | tools/scripts/init_db.sh |
| tools/test-ci.sh | tools/ci/test-ci.sh |
| tools/lint_structure.sh | tools/ci/lint_structure.sh |

## 6. 实施计划

| Phase | 任务 | 产物 |
|-------|------|------|
| 1 | 环境变量模板 | `.env.example`, tools/envs/ |
| 2 | Docker Compose 分层 | 三个 compose 文件 |
| 3 | tools/ 目录迁移 | scripts/, ci/ 子目录 |
| 4 | CI 集成 | .github/workflows/ci.yml |
| 5 | 文档更新 | README, tools/README.md |

## 7. 风险与缓解

| 风险 | 缓解 |
|------|------|
| Label 前缀遗漏 → 数据污染 | 单元测试 + Repository 封装 |
| .env 泄露密码 | .gitignore + Infisical |
| 多环境端口冲突 | 脚本启动前检查端口 |

## 8. 参考

- [BRN-004: 环境决策](../../origin/BRN-004.dev_test_prod_design.md)
- [IRD-004: 基础设施](../infra/IRD-004.dev_test_prod_infra.md)
- [12-Factor App: Config](https://12factor.net/config)

