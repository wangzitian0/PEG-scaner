# TRD-005: CMS + Neo4j Graph Admin + æ•°æ®æµæ°´çº¿

> å¯¹åº” BRN-005.schema.md

## 1. ç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ |
|------|------|
| æ•°æ®æµæ°´çº¿ | çˆ¬è™« â†’ æ¸…æ´— â†’ å®¡æ ¸ â†’ å†™åº“ |
| Admin UI | Django Admin ç®¡ç†æµæ°´çº¿ |
| Auth å…±äº« | Django è®¤è¯ï¼ŒFastAPI éªŒè¯ |
| æ¨¡å‹ SSOT | `libs/` å•ä¸€æ¥æº |

## 2. æ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         libs/ (SSOT)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ neo4j_models/   â”‚  â”‚ neo4j_repo/     â”‚  â”‚ auth/           â”‚   â”‚
â”‚  â”‚ (neomodel èŠ‚ç‚¹) â”‚  â”‚ (Repository)    â”‚  â”‚ (JWT Token)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                     â”‚
            â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  apps/backend/       â”‚ â”‚  apps/cms/           â”‚
â”‚  (FastAPI - åªè¯»)    â”‚ â”‚  (Django - å†™å…¥)     â”‚
â”‚  - GraphQL Query     â”‚ â”‚  - Admin UI          â”‚
â”‚  - verify_token()    â”‚ â”‚  - create_token()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Neo4j   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµæ°´çº¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRAWL   â”‚â”€â”€â”€â–¶â”‚ CLEAN   â”‚â”€â”€â”€â–¶â”‚ REVIEW  â”‚â”€â”€â”€â–¶â”‚ COMMIT  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚              â”‚              â”‚
     â–¼              â–¼              â–¼              â–¼
 RawResponse    DataBatch      DataBatch      Neo4j
 (SQLiteå½’æ¡£)   (ç™½åå•æ ¡éªŒ)   (äººå·¥å®¡æ ¸)      å†™å…¥
```

**çŠ¶æ€æµè½¬**: `raw â†’ cleaning â†’ clean â†’ reviewing â†’ approved â†’ committed`

### 2.3 å­—æ®µå¤„ç†

```
åŸå§‹ Response
     â”‚
     â”œâ”€â–¶ ç™½åå•å­—æ®µ â”€â–¶ æ ¡éªŒ â”€â–¶ å®¡æ ¸ â”€â–¶ Neo4j
     â”‚
     â””â”€â–¶ å…¶ä»–å­—æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Neo4j (é€ä¼ )
     
     â””â”€â–¶ å®Œæ•´æ•°æ® â”€â–¶ PostgreSQL (å½’æ¡£)
```

## 3. ç›®å½•ç»“æ„

```
libs/
â”œâ”€â”€ schema/                 # â­ æ•°æ®å¥‘çº¦ (SSOT)
â”‚   â”œâ”€â”€ graphql/            # GraphQL SDL (API å¥‘çº¦)
â”‚   â””â”€â”€ whitelist/          # å­—æ®µç™½åå• (æ ¡éªŒå¥‘çº¦)
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ company.py      # Company ç™½åå•å­—æ®µ
â”‚       â”œâ”€â”€ quote.py        # Quote ç™½åå•å­—æ®µ
â”‚       â””â”€â”€ earnings.py     # Earnings ç™½åå•å­—æ®µ
â”œâ”€â”€ neo4j_models/           # Neo4j æ¨¡å‹
â”‚   â”œâ”€â”€ base.py             # TimestampedNode
â”‚   â”œâ”€â”€ company.py          # Company, Sector
â”‚   â”œâ”€â”€ quote.py            # DailyQuote
â”‚   â”œâ”€â”€ earnings.py         # EarningsReport
â”‚   â”œâ”€â”€ news.py             # NewsArticle
â”‚   â””â”€â”€ pipeline.py         # CrawlerTask, DataBatch
â”œâ”€â”€ neo4j_repo/             # Repository å±‚
â””â”€â”€ auth/                   # å…±äº«è®¤è¯
    â””â”€â”€ jwt_utils.py
```

```
apps/cms/
â”œâ”€â”€ pipeline/               # æµæ°´çº¿ App
â”‚   â”œâ”€â”€ models.py           # RawResponse (PostgreSQL å½’æ¡£)
â”‚   â”œâ”€â”€ admin.py            # æµæ°´çº¿ç®¡ç† Admin
â”‚   â””â”€â”€ services.py         # æµæ°´çº¿æ“ä½œ (è°ƒç”¨ libs/)
â””â”€â”€ cms_content/            # CMS å†…å®¹
```

**ä¾èµ–æ–¹å‘**:
```
apps/cms  â”€â”€â–¶  libs/schema     (ç™½åå•å®šä¹‰)
          â”€â”€â–¶  libs/neo4j_*    (æ¨¡å‹/ä»“åº“)
          â”€â”€â–¶  libs/auth       (è®¤è¯)

apps/backend â”€â”€â–¶ libs/schema   (GraphQL)
             â”€â”€â–¶ libs/neo4j_*  (åªè¯»)
             â”€â”€â–¶ libs/auth     (éªŒè¯)
```

## 4. æ•°æ®æ¨¡å‹

### 4.1 æµæ°´çº¿èŠ‚ç‚¹ (Neo4j - `libs/neo4j_models/`)

| èŠ‚ç‚¹ | å…³é”®å­—æ®µ | è¯´æ˜ |
|------|----------|------|
| `CrawlerTask` | name, source_type, status | çˆ¬è™«ä»»åŠ¡ |
| `DataBatch` | batch_id, status, record_count | æ•°æ®æ‰¹æ¬¡ |

### 4.2 å½’æ¡£æ¨¡å‹ (PostgreSQL - `apps/cms/`)

| æ¨¡å‹ | å…³é”®å­—æ®µ | è¯´æ˜ |
|------|----------|------|
| `RawResponse` | source, raw_json, created_at | åŸå§‹å“åº”å½’æ¡£ |

### 4.3 ç™½åå•å®šä¹‰ (`libs/schema/whitelist/`)

| æ–‡ä»¶ | å†…å®¹ |
|------|------|
| `company.py` | `REQUIRED = ['ticker', 'name']`, `VALIDATED = ['exchange', 'sector']` |
| `quote.py` | `REQUIRED = ['ticker', 'date', 'close']`, `VALIDATED = ['volume']` |
| `earnings.py` | `REQUIRED = ['ticker', 'fiscal_period']`, `VALIDATED = ['eps', 'revenue']` |

## 5. Auth å…±äº«

| ç»„ä»¶ | èŒè´£ |
|------|------|
| `libs/auth/jwt_utils.py` | Token ç”Ÿæˆ/éªŒè¯ |
| Django | ç”¨æˆ·ç™»å½• â†’ `create_token()` |
| FastAPI | è¯·æ±‚å¤´ â†’ `verify_token()` |

## 6. é…ç½®

| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `JWT_SECRET_KEY` | dev-secret | JWT å¯†é’¥ |
| `NEO4J_URI` | bolt://localhost:7687 | Neo4j |
| `DB_TABLE_PREFIX` | dev_ | Label å‰ç¼€ |

## 7. éªŒæ”¶æ ‡å‡†

| # | æ ‡å‡† |
|---|------|
| 1 | æ¨¡å‹åœ¨ `libs/` å•ä¸€æ¥æº |
| 2 | FastAPI èƒ½è¯»å– Neo4j |
| 3 | Django Admin ç®¡ç†æµæ°´çº¿ |
| 4 | JWT Token å…±äº«è®¤è¯ |
| 5 | ç™½åå•å­—æ®µèµ°å®¡æ ¸ï¼Œå…¶ä»–é€ä¼  |
| 6 | åŸå§‹å“åº”å½’æ¡£åœ¨ SQLite |

---

**çŠ¶æ€**: ğŸ“‹ å¾…ç¡®è®¤
