# TRD-002: Strawberry + FastAPI 实现（对应 BRN-002）

## 1. 背景
基于 BRN-002 决策，采用 Strawberry GraphQL + FastAPI + neomodel + Neo4j 技术栈，替代 Flask + Ariadne。实现独立 app 架构（backend/crawler/etl）+ 共享 libs（neo4j-repo）。

## 2. 技术选型对比

### GraphQL 框架
| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| **Strawberry** | dataclass 风格、类型安全、Pydantic 集成、活跃维护 | 生态相对年轻 | ✅ 采用 |
| Ariadne（当前） | SDL-first、简单易用 | 手动绑定 resolver、类型提示弱 | ❌ 替换 |
| Graphene | 成熟稳定 | Code-first、与 SDL 分离、维护不活跃 | ❌ 不采用 |

### Web 框架
| 方案 | 优点 | 缺点 | 决策 |
|------|------|------|------|
| **FastAPI** | ASGI 异步、依赖注入、OpenAPI 自动生成 | 学习曲线略高 | ✅ 采用 |
| Flask（当前） | 简单易用、生态成熟 | 同步模型、扩展性弱 | ❌ 替换 |

## 3. 整体架构

### 3.1 系统架构（独立 app）
```mermaid
graph TB
    subgraph "libs（共享）"
        Schema[schema/<br/>GraphQL SDL]
        Repo[neo4j-repo/<br/>Repository+Models]
    end
    
    subgraph "apps（独立）"
        Backend[backend/<br/>GraphQL API]
        Crawler[crawler/<br/>爬虫服务]
        ETL[etl/<br/>ETL服务]
    end
    
    subgraph "数据"
        Neo4j[(Neo4j)]
    end
    
    Backend --> Schema
    Backend --> Repo
    Crawler --> Repo
    ETL --> Repo
    Repo --> Neo4j
    
    style Backend fill:#e1f5ff
    style Crawler fill:#fff4e1
    style ETL fill:#ffe1f5
```

### 3.2 Backend 三层分离
```mermaid
graph LR
    Client[Client] -->|GraphQL| GQL[GraphQL Resolver<br/>薄层]
    GQL --> SVC[Service<br/>业务逻辑]
    SVC --> REPO[Repository<br/>libs/neo4j-repo]
    REPO --> DB[(Neo4j)]
```

### 3.3 调用关系
```
POST /graphql
 → FastAPI Router
   → Strawberry.execute()
     → Resolver.ping() / .peg_stocks()
       → StockService.get_single_stock_page(symbol)
         → StockRepository.find_company(symbol)
         → StockRepository.fetch_daily_kline(symbol)
           → Neo4j Cypher Query
```

## 4. 目录结构设计

### 4.1 完整结构
```
libs/
├── schema/                      # GraphQL SDL（SSOT）
│   ├── common/types.graphql     # 通用（Pagination）
│   ├── market/market.graphql    # 市场域
│   ├── news/news.graphql        # 新闻域（占位）
│   ├── schema.graphql           # 聚合产物
│   ├── merge_schema.py          # 聚合脚本
│   └── README.md
│
└── neo4j-repo/                  # 共享数据访问层
    ├── connection.py
    ├── repositories/stock_repository.py
    ├── models/stock.py          # neomodel 节点
    └── README.md

apps/
├── backend/                     # GraphQL API
│   ├── main.py                  # FastAPI entry
│   ├── config.py
│   ├── graphql/                 # Strawberry Resolvers
│   │   ├── __init__.py          # 合并 Query
│   │   ├── ping.py
│   │   └── stock.py
│   ├── services/                # 业务逻辑
│   │   └── stock_service.py
│   ├── tests/
│   └── requirements.txt
│
├── crawler/                     # 独立爬虫（未来）
└── etl/                         # 独立ETL（未来）
```

### 4.2 Schema 多域管理
- **命名约定**：`Asset` 前缀（market），`News` 前缀（news）
- **依赖顺序**：common → domain，禁止域间交叉引用
- **聚合流程**：`python merge_schema.py` → `npm run codegen`

## 5. 关键接口（伪代码）

### 5.1 Resolver（薄层）
```python
# apps/backend/graphql/stock.py
@strawberry.type
class Query:
    @strawberry.field
    def single_stock(self, info, symbol: str) -> Optional[SingleStockPage]:
        service = info.context["stock_service"]
        return service.get_single_stock_page(symbol)
```

### 5.2 Service（业务逻辑）
```python
# apps/backend/services/stock_service.py
class StockService:
    def get_single_stock_page(self, symbol: str):
        company = self.repo.find_company(symbol)
        kline = self.repo.fetch_daily_kline(symbol, 30)
        news = self.repo.fetch_news(symbol, 10)
        return build_response(company, kline, news)
```

### 5.3 Repository（数据访问）
```python
# libs/neo4j-repo/repositories/stock_repository.py
class StockRepository:
    def find_company(self, ticker: str):
        return Company.nodes.get_or_none(ticker=ticker)
    
    def fetch_daily_kline(self, ticker: str, limit: int):
        query = "MATCH (:Company {ticker:$ticker})-[:HAS_QUOTE]->(q) ..."
        return db.cypher_query(query, {"ticker": ticker, "limit": limit})
```

## 6. Neo4j 数据模型（参考 BRN-005）

### 6.1 核心节点与关系
```cypher
// 节点
(:Company {ticker, name, sector})
(:DailyQuote {date, open, high, low, close, volume})
(:NewsArticle {title, url, source})

// 关系
(Company)-[:HAS_QUOTE {confidence}]->(DailyQuote)
(Company)-[:MENTIONED_IN]->(NewsArticle)

// 约束
CREATE CONSTRAINT Company_ticker FOR (c:Company) REQUIRE c.ticker IS NODE KEY;
```

### 6.2 连接管理
```python
# libs/neo4j-repo/connection.py
@asynccontextmanager
async def lifespan(app):
    db.set_connection(os.getenv("NEO4J_URI"))
    yield
    db.close_connection()

# apps/backend/main.py
app = FastAPI(lifespan=lifespan)
```

## 7. 测试策略

### 7.1 单元测试（Service + Mock）
```python
def test_service(mocker):
    mock_repo = mocker.Mock()
    mock_repo.find_company.return_value = Company(ticker="AAPL")
    service = StockService(repo=mock_repo)
    assert service.get_single_stock_page("AAPL").stock.symbol == "AAPL"
```

### 7.2 GraphQL 集成测试
```python
from fastapi.testclient import TestClient
def test_ping():
    client = TestClient(app)
    response = client.post("/graphql", json={"query": "{ ping { message } }"})
    assert response.json()["data"]["ping"]["message"] == "pong"
```

## 8. 部署与运维

### 8.1 启动命令
```bash
# 开发：uvicorn apps.backend.main:app --reload
# 生产：uvicorn apps.backend.main:app --workers 4
```

### 8.2 环境变量
```env
NEO4J_URI=bolt://neo4j:password@localhost:7687
DEBUG=true  # Playground 启用开关
```

### 8.3 容器部署
```yaml
# docker-compose.yml
services:
  backend:
    build: ./apps/backend
    command: uvicorn main:app --host 0.0.0.0
    environment:
      NEO4J_URI: bolt://neo4j:7687
  
  crawler:  # 未来
    build: ./apps/crawler
```

## 9. 实施计划

### 9.1 分阶段迁移（7 Phase，预估 10h）
| Phase | 任务 | 验收标准 | 工时 |
|-------|------|---------|------|
| 1 | 环境准备 | requirements.txt 更新，pip install 成功 | 0.5h |
| 2 | Schema 拆分 | merge_schema.py 生成 schema.graphql | 1h |
| 3 | 创建 libs/neo4j-repo | 单元测试通过 | 2h |
| 4 | backend 新目录 | 目录创建完成 | 0.5h |
| 5 | 迁移逻辑 | uvicorn 启动，ping 成功 | 3h |
| 6 | 测试更新 | backend:test + regression:ping 全绿 | 2h |
| 7 | 清理文档 | 旧代码删除，文档更新 | 1h |

### 9.2 关键文件变更
**新建**（~20 个）：
- `libs/schema/{common,market,news}/*.graphql`, `merge_schema.py`
- `libs/neo4j-repo/connection.py`, `repositories/`, `models/`
- `apps/backend/main.py`, `graphql/{ping,stock}.py`, `services/stock_service.py`

**修改**（~10 个）：
- `apps/backend/requirements.txt`, `project.json`, `README.md`
- `apps/backend/tests/test_graphql.py`, `conftest.py`

**删除**（~3 个）：
- `pegserver/graphql_api.py` (→ `_legacy.py` 备份)

### 9.3 风险与缓解
| 风险 | 缓解措施 |
|------|---------|
| Strawberry API 不熟悉 | 先读官方文档，参考 examples |
| Neo4j 连接生命周期 | FastAPI lifespan hook 统一管理 |
| 测试用例重写工作量 | TestClient API 类似，改动不大 |

### 9.4 回滚方案
- 保留 `pegserver_legacy/` + `requirements.legacy.txt`
- 修改 `project.json` 启动命令即可回滚
- Git tag `v0.1-flask` 标记迁移前版本

## 10. 参考文档
- [BRN-002: GraphQL 协议决策](../../origin/BRN-002.graphql_protocol_decision.md)
- [BRN-005: Neo4j Schema](../../origin/BRN-005.schema.md)
- [project/BRN-002/: 迭代执行记录](../../project/BRN-002/)
- [Strawberry 官方文档](https://strawberry.rocks/)
- [FastAPI 官方文档](https://fastapi.tiangolo.com/)

