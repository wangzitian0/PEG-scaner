# TRD-002: Strawberry + FastAPI 实现（对应 BRN-002）

## 1. 背景
基于 BRN-002 决策，采用 Strawberry GraphQL + FastAPI + neomodel + Neo4j 技术栈，替代 Flask + Ariadne。

## 2. 技术选型对比

| 方案 | 优点 | 缺点 | 是否采用 |
|------|------|------|---------|
| **Strawberry + FastAPI** | ASGI 异步、dataclass 风格、Pydantic 集成、OpenTelemetry 原生支持 | 生态相对年轻 | ✅ 采用 |
| Flask + Ariadne | 生态成熟、简单易用 | 同步模型、难扩展异步、依赖注入弱 | ❌ 已迁移 |
| gRPC + Proto | 二进制高效、跨语言强 | 前端支持差、调试困难、过度设计 | ❌ 不引入 |

## 3. 架构设计

### 3.1 三层分离
```mermaid
graph TD
    GraphQL[GraphQL Resolver<br/>Strawberry dataclass] --> Service[Service Layer<br/>业务逻辑+事务]
    Service --> Repo[Repository Layer<br/>neomodel + Cypher]
    Repo --> Neo4j[(Neo4j)]
    
    style GraphQL fill:#e1f5ff
    style Service fill:#fff4e1
    style Repo fill:#e8f5e9
```

### 3.2 数据流
```
Client → POST /graphql
  → FastAPI Router
    → Strawberry Schema.execute()
      → Resolver (薄层)
        → Service (业务逻辑)
          → Repository (数据访问)
            → Neo4j
```

## 4. Schema 多域管理

### 4.1 目录结构
```
libs/schema/
├── common/types.graphql       # 通用类型（Pagination, DateRange）
├── market/market.graphql      # 市场域（PegStock, SingleStockPage）
├── news/news.graphql          # 新闻域（未来扩展）
├── schema.graphql             # 聚合文件（merge 产物）
├── merge_schema.py            # 聚合脚本
└── README.md
```

### 4.2 命名约定
- **域前缀**：`Asset` (market), `News` (news), 避免冲突
- **共用类型**：放 `common/`，如 `PaginationInput`
- **依赖顺序**：common → domain，域间禁止交叉引用

### 4.3 聚合流程
```bash
python libs/schema/merge_schema.py  # 生成 schema.graphql
npm run codegen                      # 前端生成 TS 类型
```

## 5. 关键接口（伪代码）

### 5.1 Resolver 示例
```python
# api/graphql/market/schema.py
import strawberry

@strawberry.type
class Query:
    @strawberry.field
    def single_stock(
        self, 
        info: strawberry.Info,
        symbol: str
    ) -> Optional[SingleStockPage]:
        service = info.context["stock_service"]
        return service.get_single_stock_page(symbol)
```

### 5.2 Service 示例
```python
# core/services/stock_service.py
class StockService:
    def __init__(self, repo: StockRepository):
        self.repo = repo
    
    def get_single_stock_page(self, symbol: str):
        company = self.repo.find_company(symbol)
        kline = self.repo.fetch_daily_kline(symbol, limit=30)
        news = self.repo.fetch_news(symbol, limit=10)
        return build_response(company, kline, news)
```

### 5.3 Repository 示例
```python
# infra/neo4j/repositories/stock_repository.py
class StockRepository:
    def find_company(self, ticker: str):
        return Company.nodes.get_or_none(ticker=ticker)
    
    def fetch_daily_kline(self, ticker: str, limit: int):
        # 复杂查询用 Cypher
        query = """
        MATCH (c:Company {ticker: $ticker})-[:HAS_QUOTE]->(q:DailyQuote)
        RETURN q ORDER BY q.date DESC LIMIT $limit
        """
        return db.cypher_query(query, {"ticker": ticker, "limit": limit})
```

## 6. Neo4j Schema（数据模型）

### 6.1 核心节点（参考 BRN-005）
```cypher
// 节点定义
(:Company {ticker, name, sector, industry})
(:DailyQuote {date, open, high, low, close, volume})
(:NewsArticle {title, url, source, publishedAt})

// 关系定义
(Company)-[:HAS_QUOTE {confidence}]->(DailyQuote)
(Company)-[:MENTIONED_IN]->(NewsArticle)

// 约束
CREATE CONSTRAINT Company_ticker FOR (c:Company) REQUIRE c.ticker IS NODE KEY;
CREATE INDEX Company_sector FOR (c:Company) ON (c.sector);
```

### 6.2 连接生命周期
```python
# infra/neo4j/connection.py
from contextlib import asynccontextmanager

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    config.DATABASE_URL = os.getenv("NEO4J_URI")
    db.set_connection(config.DATABASE_URL)
    yield
    # Shutdown
    db.close_connection()
```

## 7. 测试策略

### 7.1 单元测试（Service + Mock Repo）
```python
def test_get_stock(mocker):
    mock_repo = mocker.Mock()
    mock_repo.find_company.return_value = Company(ticker="AAPL")
    
    service = StockService(repo=mock_repo)
    result = service.get_single_stock_page("AAPL")
    
    assert result.stock.symbol == "AAPL"
```

### 7.2 GraphQL 测试
```python
def test_ping_query():
    client = TestClient(app)
    response = client.post("/graphql", json={
        "query": "query { ping { message } }"
    })
    assert response.json()["data"]["ping"]["message"] == "pong"
```

## 8. 部署与运维

### 8.1 启动命令
```bash
# 开发环境
uvicorn apps.backend.src.main:app --reload --port 8000

# 生产环境
uvicorn apps.backend.src.main:app --workers 4 --host 0.0.0.0
```

### 8.2 环境变量
```env
NEO4J_URI=bolt://neo4j:password@localhost:7687
DEBUG=false
AGENT_NAME=backend-prod-v1
```

### 8.3 Playground 访问控制
```python
app.include_router(
    GraphQLRouter(
        schema,
        graphiql=os.getenv("DEBUG") == "true"  # 仅 dev 启用
    ),
    prefix="/graphql"
)
```

## 9. 迁移路径（Flask → FastAPI）
1. ✅ 保留旧代码（重命名为 `*_legacy.py`）
2. ✅ 分阶段迁移（ping → pegStocks → singleStock）
3. ✅ 回归测试全绿后删除 Flask 代码

## 10. 参考资源
- [Strawberry 官方文档](https://strawberry.rocks/)
- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [neomodel 文档](https://neomodel.readthedocs.io/)
- [BRN-002: GraphQL 协议决策](../../origin/BRN-002.graphql_protocol_decision.md)
- [BRN-005: Neo4j Schema 设计](../../origin/BRN-005.schema.md)

