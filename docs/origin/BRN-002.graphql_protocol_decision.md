# BRN-002: GraphQL 协议与通信依赖
1. 决策：选择 Strawberry GraphQL + FastAPI，保持强类型 Resolver 体验并获取 ASGI/异步生态。
2. GraphQL SDL (`libs/schema/schema.graphql`) 是唯一事实来源，所有客户端代码靠生成器同步类型。
3. 传输层维持 HTTP/JSON，GraphQL 负责 schema 约束，JSON 仅作载体，避免弱约定。
4. 不引入 gRPC/Thrift/Proto，以降低协议面复杂度并保持一次建模多端消费。
5. Strawberry 提供 dataclass 风格 resolver 与 Pydantic/typing 紧密配合，易被 Nx/TS 生态消费。
6. FastAPI 提供生命周期管理、依赖注入、OpenTelemetry hook 以及 ASGI server（uvicorn）默认实现。
7. 认证/限流等横切关注点通过 FastAPI middleware 实现，GraphQL 仅聚焦数据 shape。
8. Neo4j 作为事实存储；neomodel 负责节点/关系建模，复杂查询直接写 Cypher repository。
9. 数据一致性策略：GraphQL Mutation → service 层 → repository (neomodel/Cypher) → Neo4j，所有写入记录 provenance。
10. Schema 变更/多域：在 `libs/schema/{common,market,news,...}/` 分域维护 SDL，脚本聚合成 `schema.graphql` 并更新 README → codegen → Resolver/Type 同步。
11. 测试优先级：`apps/backend/tests/graphql/` 覆盖 Resolver + 服务层；`apps/regression/` 做端到端验证。
12. 目录结构（核心）：
```
libs/
  schema/ (schema.graphql + {common,market,news}/ SDL)
  neo4j-repo/ (connection, repositories, models)
apps/
  backend/                    # FastAPI GraphQL API
    main.py, config.py, graphql/, services/
  crawler/                    # 独立爬虫服务（yfinance/SEC/news）
    main.py, spiders/, config.py
  etl/                        # 独立ETL服务（聚合/校验/质量监控）
    main.py, jobs/, config.py
  regression/                 # E2E测试
tools/
  dev.sh                      # 启停 & codegen
```
13. 部署：容器内运行 `uvicorn apps.backend.src.main:app`；GraphQL Playground 仅限内网调试。