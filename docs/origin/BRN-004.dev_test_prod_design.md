# BRN-004: 开发/测试/生产环境机制
整体目标：用 Git + Docker Compose 管结构，用 Infisical 管所有环境变量，让 5 套环境（dev/ci/test/staging/prod）都能一键起、自动化部署，同时保持配置只有一个真理源。  

## 总体目标  
代码库是公开 monorepo，包含应用代码和一套通用的 Docker Compose 模板，不包含任何真实密钥。  
所有敏感配置和各环境差异（DB 地址、密码、开关等）都集中放在自托管的 Infisical 中，按环境分层管理并带版本历史和回滚能力。[3]
dev/ci要一键跑起来。

## 配置与 SSOT  
应用只通过环境变量读取配置，不关心这些变量从哪里来，从而让“谁提供变量”这件事完全交给 Infisical 和启动脚本。  
本地/CI 可以用默认值或从 Infisical 导出的 `.env` 文件，test/staging/prod 强制从 Infisical 导出当前版本，保证所有运行时配置都来自同一个中心。  

## Docker 与环境划分  
仓库下有一个 `compose.base.yml` 描述所有环境共有的服务结构，再为 dev/ci/test/staging/prod 各有一个小的 override 文件，只覆盖端口、卷挂载、Traefik 路由、是否起本地 DB 等差异。  
每次启动时用 `docker compose -f base -f ${ENV}.yml --env-file .env.${ENV} -p app-${ENV} up` 这种固定命令，把“结构差异”和“参数差异”清晰分层，减少复制粘贴和配置漂移。  

## 部署与 MR 流程  
本地开发：脚本先从 Infisical 导出 dev 环境变量到 `.env`，再用 dev 的 Compose 覆盖文件起全栈（包括 Neo4j/Postgres），实现一键 demo/测试环境。  
CI：用 `.env` 文件起轻量依赖跑测试，保证本地和线上的强一致。用完就丢，追求速度，尽快的测试所有代码。
test: MR 合并请求额外触发一个“预览环境”工作流test_mr_xx，并通过 Traefik+Cloudflare 给出 `pr-xxx.truealpha.club` 供手工验证。代码合并之后自动丢弃环境和数据。
staging：我会定期 dump 数据到 staging，提供和线上高度相似的环境，用于 post-merge 测试之类的。
prod：通过 Infisical 提供的正式连接串连到共享数据库和 Neo4j。  
流程：大部分需求是逐级开发的，少部分可以通过 bot 打标，直接部署到 staging。

## 维护成本为何低  
新增或修改服务结构，只动 base/单个 override 文件；环境变量变化，只在 Infisical 改一处并自动记录历史，不再到处翻 `.env` 或 Dokploy 面板。  
所有环境的最终配置都可以通过 `docker compose config` 和 Infisical 的版本历史审查与回滚，问题出现时能快速定位是“结构错”还是“参数错”，长期维护成本稳定可控。

[1](https://blog.csdn.net/gitblog_00723/article/details/147291579)
[2](https://blog.csdn.net/gitblog_00377/article/details/148375070)
[3](https://blog.csdn.net/Mrex326428/article/details/141426852)
[4](https://github.com/svg153/awesome-stars)
[5](https://blog.csdn.net/gitblog_00301/article/details/152405582)
[6](https://blog.csdn.net/gitblog_01036/article/details/152402584)
[7](https://github.com/hiifong/starList)
[8](https://www.cnblogs.com/yjbjingcha/p/19047530)
[9](https://www.githubshare.com/archives)

