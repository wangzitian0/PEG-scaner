# BRN-007: 开发/测试/生产三环境机制

## 1. Why（业务价值）
1. 开发效率：代码改动需重启，反馈慢；本地手动配数据库
2. 环境污染：dev/test/prod 数据混在一个库，误删风险高
3. 部署不一致：本地跑通，CI 失败；CI 通过，生产挂
4. 依赖复杂：每次启动需手动起 Neo4j/Redis，忘了就报错

## 2. What（范围）
| 环境 | 启动 | 热更新 | 数据隔离 |
|------|------|--------|---------|
| dev | `npm run dev` | uvicorn --reload + Vite HMR | `dev_` 前缀 |
| test | `nx run regression:*` | 无（快速启停） | `test_` 前缀 |
| prod | `npm start` / Docker | 无（多 worker） | `prod_` 前缀 |

核心能力：
1. **热更新**：修改 Python/TS 代码 <2s 自动重载
2. **Docker 一键拉起**：`docker-compose up neo4j-dev` 启动依赖
3. **环境变量控制**：`.env.dev/.test/.prod` + `PEG_ENV`，读取不同配置和数据库前缀

## 3. 验收标准
**开发环境（dev）**
- [ ] `npm run dev` 一键启动 Neo4j + Backend + Frontend
- [ ] 修改 Python/TS 后 <2s 生效，无需重启
- [ ] Neo4j 数据持久化到 `x-data/neo4j/dev/`

**测试环境（test）**
- [ ] CI 运行 `nx run regression:*` 自动拉起独立容器
- [ ] 测试数据用 `test_` 前缀，不污染 dev/prod

**生产环境（prod）**
- [ ] `docker-compose up` 启动生产栈（多 worker）
- [ ] 关闭 GraphiQL，数据前缀 `prod_`

**环境隔离**
- [ ] dev 写 `(:dev_Company)`, prod 写 `(:prod_Company)`
- [ ] 三环境可同时运行（不同端口）
- [ ] 切换环境只需改 `PEG_ENV`，代码零修改

## 4. 技术方案（摘要）
- **环境变量**：`.env.{dev,test,prod}` 文件，`DB_TABLE_PREFIX` 自动前缀
- **Docker Compose**：三组 Neo4j 服务（不同端口 7687/7688/7689）
- **热更新**：uvicorn `--reload`（已有），Vite HMR（已有）
- **数据隔离**：`connection.py` 已有 `prefixed_label()` 方法

详见 [TRD-007](../specs/tech/TRD-007.md)。

