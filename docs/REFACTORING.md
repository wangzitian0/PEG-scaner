# é¡¹ç›®é‡æ„æ–‡æ¡£

## ğŸ“‹ é‡æ„ç›®æ ‡

æ ¹æ® `REQUIREMENTS.md` çš„ä¸¤ä¸ªæ ¸å¿ƒåŸåˆ™è¿›è¡Œå…¨é¢é‡æ„ï¼š

1. **SSOT (Single Source of Truth)**ï¼šæœ¬è´¨ç›¸åŒçš„ä¸œè¥¿æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹æˆ–ä¸€ä¸ªæ–‡ä»¶
2. **æ•°æ®æŒä¹…åŒ–**ï¼šæ•°æ®å¤„ç†çš„ä¸­é—´è¿‡ç¨‹å°½å¯èƒ½æŒä¹…åŒ–ï¼Œä¾¿äºè°ƒè¯•

---

## ğŸ”„ é‡æ„å‰åå¯¹æ¯”

### æ ¹ç›®å½•ç»“æ„

**é‡æ„å‰**ï¼ˆæ··ä¹±ï¼‰ï¼š
```
PEG-scaner/
â”œâ”€â”€ README.md
â”œâ”€â”€ agent.md
â”œâ”€â”€ QUICKSTART.md
â”œâ”€â”€ ITERATION_SUMMARY.md
â”œâ”€â”€ FINAL_REPORT.md
â”œâ”€â”€ prompt.md
â”œâ”€â”€ requirements.txt         # âš ï¸ é‡å¤
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ cache/                   # âš ï¸ æ•°æ®åˆ†æ•£
â”œâ”€â”€ results/                 # âš ï¸ æ•°æ®åˆ†æ•£
â”œâ”€â”€ logs/                    # âš ï¸ æ•°æ®åˆ†æ•£
â”œâ”€â”€ core/
â”œâ”€â”€ data_collection/
â”œâ”€â”€ backtest/
â””â”€â”€ tests/
```

**é‡æ„å**ï¼ˆæ¸…æ™°ï¼‰ï¼š
```
PEG-scaner/
â”œâ”€â”€ ğŸ“„ README.md             âœ¨ ç®€æ´ç‰ˆï¼ˆæŒ‡å‘docsï¼‰
â”œâ”€â”€ ğŸ“„ agent.md              æ ¸å¿ƒè®¾è®¡æ–‡æ¡£
â”œâ”€â”€ ğŸ“„ config.yaml           å•ä¸€é…ç½®æºï¼ˆSSOTï¼‰
â”œâ”€â”€ ğŸ“„ pyproject.toml        å”¯ä¸€ä¾èµ–å®šä¹‰
â”‚
â”œâ”€â”€ ğŸ“š docs/                 âœ¨ æ‰€æœ‰æ–‡æ¡£ï¼ˆSSOTï¼‰
â”‚   â”œâ”€â”€ README.md            å®Œæ•´æ–‡æ¡£
â”‚   â”œâ”€â”€ QUICKSTART.md        å¿«é€Ÿå…¥é—¨
â”‚   â”œâ”€â”€ REQUIREMENTS.md      åŸå§‹éœ€æ±‚
â”‚   â”œâ”€â”€ ITERATION_SUMMARY.md å¼€å‘å†ç¨‹
â”‚   â”œâ”€â”€ FINAL_REPORT.md      æœ€ç»ˆæŠ¥å‘Š
â”‚   â””â”€â”€ REFACTORING.md       é‡æ„æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰
â”‚
â”œâ”€â”€ ğŸ’¾ data/                 âœ¨ æ‰€æœ‰æ•°æ®ï¼ˆæŒä¹…åŒ–ï¼‰
â”‚   â”œâ”€â”€ raw/                 APIåŸå§‹å“åº”ï¼ˆ7å¤©ï¼‰
â”‚   â”œâ”€â”€ processed/           å¤„ç†åæ•°æ®ï¼ˆ30å¤©ï¼‰
â”‚   â”œâ”€â”€ cache/               ç¼“å­˜æ•°æ®ï¼ˆ24å°æ—¶ï¼‰
â”‚   â”œâ”€â”€ results/             æœ€ç»ˆç»“æœï¼ˆæ°¸ä¹…ï¼‰
â”‚   â”œâ”€â”€ logs/                å¤„ç†æ—¥å¿—ï¼ˆ90å¤©ï¼‰
â”‚   â””â”€â”€ README.md            æ•°æ®ç®¡ç†è¯´æ˜
â”‚
â”œâ”€â”€ ğŸ§  core/                 æ ¸å¿ƒä»£ç 
â”‚   â”œâ”€â”€ schemas/             Schemaå®šä¹‰ï¼ˆSSOTï¼‰
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ format_utils.py
â”‚   â””â”€â”€ data_persistence.py  âœ¨ æŒä¹…åŒ–å·¥å…·
â”‚
â”œâ”€â”€ ğŸ“¡ data_collection/      æ•°æ®é‡‡é›†
â”œâ”€â”€ ğŸ“ˆ backtest/             å›æµ‹å¼•æ“
â””â”€â”€ ğŸ§ª tests/                æµ‹è¯•å¥—ä»¶
```

---

## ğŸ¯ SSOTåŸåˆ™åº”ç”¨

### 1. æ–‡æ¡£ç®¡ç†ï¼ˆSSOTï¼‰

**é—®é¢˜**ï¼šæ ¹ç›®å½•æœ‰6ä¸ª.mdæ–‡æ¡£ï¼Œæ··ä¹±

**è§£å†³**ï¼š
```bash
# æ‰€æœ‰æ–‡æ¡£ç§»åˆ° docs/
docs/
â”œâ”€â”€ README.md              # å®Œæ•´æ–‡æ¡£
â”œâ”€â”€ QUICKSTART.md          # å¿«é€Ÿå…¥é—¨
â”œâ”€â”€ REQUIREMENTS.md        # åŸå§‹éœ€æ±‚
â”œâ”€â”€ ITERATION_SUMMARY.md   # è¿­ä»£æ€»ç»“
â”œâ”€â”€ FINAL_REPORT.md        # æœ€ç»ˆæŠ¥å‘Š
â””â”€â”€ REFACTORING.md         # é‡æ„æ–‡æ¡£
```

**æ”¶ç›Š**ï¼š
- âœ… æ ¹ç›®å½•ç®€æ´æ¸…æ™°
- âœ… æ–‡æ¡£é›†ä¸­ç®¡ç†
- âœ… æ˜“äºç»´æŠ¤å’ŒæŸ¥æ‰¾

### 2. ä¾èµ–ç®¡ç†ï¼ˆSSOTï¼‰

**é—®é¢˜**ï¼š`requirements.txt` å’Œ `pyproject.toml` é‡å¤

**è§£å†³**ï¼š
```bash
# åˆ é™¤ requirements.txt
rm requirements.txt

# åªä¿ç•™ pyproject.toml ä½œä¸ºå”¯ä¸€ä¾èµ–å®šä¹‰
```

**æ”¶ç›Š**ï¼š
- âœ… å•ä¸€ä¾èµ–æº
- âœ… é¿å…ä¸ä¸€è‡´
- âœ… uvåŸç”Ÿæ”¯æŒ

### 3. é…ç½®ç®¡ç†ï¼ˆSSOTï¼‰

**é—®é¢˜**ï¼šé…ç½®åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶

**è§£å†³**ï¼š
```yaml
# config.yaml - å•ä¸€é…ç½®æº
data:
  base_dir: "./data"
  raw:
    directory: "./data/raw"
    retention_days: 7
  processed:
    directory: "./data/processed"
    retention_days: 30
  cache:
    directory: "./data/cache"
    expiry_hours: 24
  results:
    directory: "./data/results"
  logs:
    directory: "./data/logs"
    retention_days: 90
```

**æ”¶ç›Š**ï¼š
- âœ… ç»Ÿä¸€é…ç½®ç®¡ç†
- âœ… æ˜“äºä¿®æ”¹
- âœ… å¯ç‰ˆæœ¬æ§åˆ¶

### 4. Schemaå®šä¹‰ï¼ˆSSOTï¼‰

**ä¿æŒ**ï¼š
```
core/schemas/          # âœ… Schemaç»Ÿä¸€å®šä¹‰
â”œâ”€â”€ stock_schema.py    # æ•°æ®æ¨¡å‹
â””â”€â”€ validation_rules.py # éªŒè¯è§„åˆ™
```

**æ”¶ç›Š**ï¼š
- âœ… å•ä¸€çœŸç›¸æº
- âœ… ç±»å‹å®‰å…¨
- âœ… è‡ªåŠ¨éªŒè¯

---

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–åŸåˆ™åº”ç”¨

### 1. ç»Ÿä¸€æ•°æ®ç›®å½•

**é—®é¢˜**ï¼šæ•°æ®åˆ†æ•£åœ¨ `cache/`, `results/`, `logs/`

**è§£å†³**ï¼š
```
data/                      # âœ¨ æ‰€æœ‰æ•°æ®ç»Ÿä¸€ç®¡ç†
â”œâ”€â”€ raw/                   # åŸå§‹æ•°æ®
â”œâ”€â”€ processed/             # å¤„ç†åæ•°æ®
â”œâ”€â”€ cache/                 # ç¼“å­˜æ•°æ®
â”œâ”€â”€ results/               # æœ€ç»ˆç»“æœ
â””â”€â”€ logs/                  # å¤„ç†æ—¥å¿—
```

**æ”¶ç›Š**ï¼š
- âœ… æ•°æ®é›†ä¸­ç®¡ç†
- âœ… æ¸…æ™°çš„æ•°æ®æµ
- âœ… æ˜“äºå¤‡ä»½å’Œæ¸…ç†

### 2. åˆ†é˜¶æ®µæŒä¹…åŒ–

**åŸåˆ™**ï¼šä¿å­˜æ¯ä¸ªå¤„ç†é˜¶æ®µçš„æ•°æ®

**å®ç°**ï¼š
```python
# 1. ä¿å­˜åŸå§‹APIå“åº”
data/raw/MSFT_yfinance_20251115_100001.json

# 2. ä¿å­˜å¤„ç†åæ•°æ®
data/processed/MSFT_processed_2025-11-15.json

# 3. ç¼“å­˜æœ€ç»ˆç»“æœ
data/cache/MSFT_2025-11-15.json

# 4. è¾“å‡ºç”¨æˆ·ç»“æœ
data/results/mag7_peg_2025-11-15.csv
```

**æ”¶ç›Š**ï¼š
- âœ… å®Œæ•´çš„æ•°æ®è¿½æº¯
- âœ… ä¾¿äºè°ƒè¯•
- âœ… å¯å›æº¯ä»»ä½•é˜¶æ®µ

### 3. Pipelineè¿½è¸ª

**æ–°å¢**ï¼š`core/data_persistence.py`

**åŠŸèƒ½**ï¼š
```python
from core.data_persistence import get_persistence_manager

pm = get_persistence_manager()

# åˆ›å»ºpipeline
pipeline = pm.create_pipeline('MSFT')

# è®°å½•æ¯ä¸ªæ­¥éª¤
pm.add_step(pipeline, 'fetch_yfinance', 'success', duration_ms=1234)
pm.add_step(pipeline, 'cross_validation', 'success', duration_ms=123,
            metadata={'consistency': 0.98})

# å®Œæˆå¹¶ä¿å­˜æ—¥å¿—
pm.complete_pipeline(pipeline)
pm.save_pipeline_log(pipeline)
```

**è¾“å‡º**ï¼š
```json
{
  "pipeline_id": "20251115_100001_MSFT",
  "ticker": "MSFT",
  "start_time": "2025-11-15T10:00:01",
  "end_time": "2025-11-15T10:00:05",
  "status": "success",
  "steps": [
    {
      "step": 1,
      "action": "fetch_yfinance",
      "timestamp": "2025-11-15T10:00:01",
      "status": "success",
      "duration_ms": 1234
    },
    {
      "step": 2,
      "action": "cross_validation",
      "timestamp": "2025-11-15T10:00:03",
      "status": "success",
      "duration_ms": 123,
      "metadata": {"consistency": 0.98}
    }
  ]
}
```

**æ”¶ç›Š**ï¼š
- âœ… å®Œæ•´çš„å¤„ç†å†å²
- âœ… æ€§èƒ½åˆ†æ
- âœ… é”™è¯¯è¿½è¸ª

### 4. æ•°æ®ä¿ç•™ç­–ç•¥

**é…ç½®åŒ–çš„ä¿ç•™æœŸ**ï¼š
```yaml
data:
  raw:
    retention_days: 7      # åŸå§‹æ•°æ®ä¿ç•™7å¤©
  processed:
    retention_days: 30     # å¤„ç†åæ•°æ®ä¿ç•™30å¤©
  cache:
    expiry_hours: 24       # ç¼“å­˜24å°æ—¶
  results:
    retention_days: -1     # æ°¸ä¹…ä¿ç•™
  logs:
    retention_days: 90     # æ—¥å¿—ä¿ç•™90å¤©
```

**è‡ªåŠ¨æ¸…ç†**ï¼š
```python
from core.data_persistence import get_persistence_manager

pm = get_persistence_manager()

# æ¸…ç†è¿‡æœŸåŸå§‹æ•°æ®
pm.cleanup_old_data('raw', days=7)

# æ¸…ç†è¿‡æœŸå¤„ç†æ•°æ®
pm.cleanup_old_data('processed', days=30)
```

---

## ğŸ“ ä»£ç å˜æ›´

### 1. è·¯å¾„æ›´æ–°

**cache_manager.py**ï¼š
```python
# ä¿®æ”¹å‰
DEFAULT_CACHE_DIR = './cache'

# ä¿®æ”¹å
DEFAULT_CACHE_DIR = './data/cache'
```

**fetch_current_peg.py**ï¼š
```python
# ä¿®æ”¹å‰
def save_results(data_list, output_dir='./results'):

# ä¿®æ”¹å
def save_results(data_list, output_dir='./data/results'):
```

### 2. é…ç½®æ›´æ–°

**config.yaml**ï¼š
```yaml
# æ–°å¢ï¼šç»Ÿä¸€çš„æ•°æ®ç®¡ç†é…ç½®
data:
  base_dir: "./data"
  raw: { ... }
  processed: { ... }
  cache: { ... }
  results: { ... }
  logs: { ... }
```

### 3. æ–°å¢å·¥å…·

**core/data_persistence.py**ï¼š
- `DataPersistence`ï¼šæ•°æ®æŒä¹…åŒ–ç®¡ç†å™¨
- `DataPipeline`ï¼šå¤„ç†pipelineè¿½è¸ª
- `ProcessingStep`ï¼šå¤„ç†æ­¥éª¤è®°å½•

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. è·¯å¾„æµ‹è¯•

```bash
# è¿è¡Œæ•°æ®é‡‡é›†
uv run python data_collection/fetch_current_peg.py

# éªŒè¯è¾“å‡ºè·¯å¾„
ls data/cache/      # âœ… ç¼“å­˜æ–‡ä»¶
ls data/results/    # âœ… ç»“æœæ–‡ä»¶
```

**ç»“æœ**ï¼šâœ… æ‰€æœ‰è·¯å¾„æ­£å¸¸å·¥ä½œ

### 2. åŠŸèƒ½æµ‹è¯•

```bash
# è¿è¡Œå…¨éƒ¨æµ‹è¯•
uv run pytest tests/ -v

# ç»“æœ
âœ… 46/46 tests passed
âœ… 48% coverage
```

### 3. æ•°æ®æŒä¹…åŒ–æµ‹è¯•

```bash
# æµ‹è¯•Pipelineè¿½è¸ª
uv run python core/data_persistence.py

# éªŒè¯æ—¥å¿—æ–‡ä»¶
ls data/logs/pipeline_*.jsonl  # âœ… æ—¥å¿—å·²ç”Ÿæˆ
```

---

## ğŸ“Š é‡æ„æ•ˆæœ

### 1. æ ¹ç›®å½•ç®€åŒ–

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹å–„ |
|------|--------|--------|------|
| æ ¹ç›®å½•æ–‡ä»¶æ•° | 15+ | 8 | **-47%** |
| æ–‡æ¡£æ–‡ä»¶ | 6ä¸ªï¼ˆåˆ†æ•£ï¼‰ | 1ä¸ªä¸»README | **-83%** |
| æ•°æ®ç›®å½• | 3ä¸ªï¼ˆåˆ†æ•£ï¼‰ | 1ä¸ªç»Ÿä¸€ | **-67%** |

### 2. æ•°æ®ç®¡ç†æ”¹å–„

| èƒ½åŠ› | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| åŸå§‹æ•°æ®ä¿å­˜ | âŒ | âœ… |
| Pipelineè¿½è¸ª | âŒ | âœ… |
| ä¸­é—´æ•°æ®æŒä¹…åŒ– | éƒ¨åˆ† | âœ… å®Œæ•´ |
| æ•°æ®è¿½æº¯èƒ½åŠ› | âŒ | âœ… |
| è‡ªåŠ¨æ¸…ç†ç­–ç•¥ | âŒ | âœ… |

### 3. SSOTç¬¦åˆåº¦

| é¡¹ç›® | é‡æ„å‰ | é‡æ„å |
|------|--------|--------|
| æ–‡æ¡£ç®¡ç† | âŒ åˆ†æ•£ | âœ… é›†ä¸­ |
| ä¾èµ–å®šä¹‰ | âš ï¸ é‡å¤ | âœ… å•ä¸€ |
| é…ç½®ç®¡ç† | âš ï¸ åˆ†æ•£ | âœ… ç»Ÿä¸€ |
| æ•°æ®å­˜å‚¨ | âŒ åˆ†æ•£ | âœ… é›†ä¸­ |

---

## ğŸ¯ æ”¶ç›Šæ€»ç»“

### 1. å¼€å‘ä½“éªŒ

- âœ… **æ¸…æ™°çš„é¡¹ç›®ç»“æ„**ï¼šä¸€ç›®äº†ç„¶
- âœ… **ç»Ÿä¸€çš„æ•°æ®ç®¡ç†**ï¼šæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… **å®Œæ•´çš„è°ƒè¯•æ”¯æŒ**ï¼šä¸­é—´æ•°æ®å¯è¿½æº¯

### 2. ä»£ç è´¨é‡

- âœ… **SSOTåˆè§„**ï¼šé¿å…é‡å¤å’Œä¸ä¸€è‡´
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•
- âœ… **å¯æµ‹è¯•æ€§**ï¼šæ•°æ®æŒä¹…åŒ–ä¾¿äºæµ‹è¯•

### 3. è¿ç»´å‹å¥½

- âœ… **è‡ªåŠ¨æ¸…ç†**ï¼šé…ç½®åŒ–çš„ä¿ç•™ç­–ç•¥
- âœ… **æ•°æ®è¿½æº¯**ï¼šå®Œæ•´çš„Pipelineå†å²
- âœ… **é”™è¯¯è¯Šæ–­**ï¼šè¯¦ç»†çš„æ—¥å¿—è®°å½•

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®README](../README.md) - é¡¹ç›®æ¦‚è§ˆ
- [æ•°æ®ç®¡ç†è¯´æ˜](../data/README.md) - æ•°æ®ç›®å½•è¯¦è§£
- [ç³»ç»Ÿè®¾è®¡](../agent.md) - æ¶æ„è®¾è®¡ï¼ˆå·²æ›´æ–°ï¼‰
- [åŸå§‹éœ€æ±‚](REQUIREMENTS.md) - è®¾è®¡åŸåˆ™æ¥æº

---

## âœ… é‡æ„æ£€æŸ¥æ¸…å•

- [x] æ‰€æœ‰æ–‡æ¡£ç§»åˆ° `docs/`
- [x] æ‰€æœ‰æ•°æ®ç§»åˆ° `data/`
- [x] åˆ é™¤é‡å¤çš„ `requirements.txt`
- [x] æ›´æ–°ä»£ç ä¸­çš„è·¯å¾„å¼•ç”¨
- [x] æ›´æ–° `config.yaml` é…ç½®
- [x] åˆ›å»º `data_persistence.py` å·¥å…·
- [x] æ›´æ–° `agent.md` è¯´æ˜æ–°åŸåˆ™
- [x] åˆ›å»º `data/README.md` è¯´æ˜
- [x] è¿è¡Œæµ‹è¯•éªŒè¯
- [x] æ›´æ–°æ ¹ç›®å½• `README.md`

---

**é‡æ„å®Œæˆæ—¶é—´**ï¼š2025-11-15  
**é‡æ„æ•ˆæœ**ï¼šâœ… å®Œå…¨ç¬¦åˆSSOTå’Œæ•°æ®æŒä¹…åŒ–åŸåˆ™  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… 46/46 passed

