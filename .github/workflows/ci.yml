name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      NX_NO_CLOUD: "true"
      NEO4J_AUTH: "neo4j/pegscanner"
      NEO4J_CONTAINER: "pegscanner_ci_neo4j"
      NEO4J_DATA_DIR: "${{ github.workspace }}/x-data/neo4j"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install npm dependencies
        run: npm install

      - name: Lint repository structure
        run: npm run lint:structure

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Backend install (venv + deps)
        run: npx nx run backend:install

      - name: Backend unit tests (protobuf ping)
        run: npx nx run backend:test

      - name: Install Playwright system dependencies
        run: sudo npx playwright install-deps chromium

      - name: Regression infra flow (backend + Vite + Neo4j)
        run: npx nx run regression:infra-flow

      - name: Regression web E2E (Playwright + Neo4j)
        run: npx nx run regression:web-e2e

      - name: Mobile typecheck
        run: npx nx run mobile:typecheck
