name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      NX_NO_CLOUD: "true"
      NEO4J_URI: "bolt://localhost:7687"
      NEO4J_USER: "neo4j"
      NEO4J_PASSWORD: "pegscanner"
      NEO4J_AUTH: "neo4j/pegscanner"
      NEO4J_CONTAINER: "pegscanner_ci_neo4j"
      NEO4J_DATA_DIR: "${{ github.workspace }}/x-data/neo4j"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Neo4j
        run: |
          docker run -d --name $NEO4J_CONTAINER \
            -p 7687:7687 -p 7474:7474 \
            -v $NEO4J_DATA_DIR:/data \
            -e NEO4J_AUTH=$NEO4J_AUTH \
            neo4j:5
          # Wait for Neo4j to be ready
          for i in {1..30}; do
            if docker exec $NEO4J_CONTAINER cypher-shell -u neo4j -p pegscanner "RETURN 1" 2>/dev/null; then
              echo "Neo4j is ready!"
              break
            fi
            echo "Waiting for Neo4j... ($i/30)"
            sleep 2
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install npm dependencies
        run: npm install

      - name: Lint repository structure
        run: npm run lint:structure

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Backend install (venv + deps)
        run: npx nx run backend:install

      - name: Backend unit tests
        run: npx nx run backend:test

      - name: Install Playwright system dependencies
        run: sudo npx playwright install-deps chromium

      - name: Regression infra flow (backend + Vite + Neo4j)
        run: npx nx run regression:infra-flow
        env:
          SKIP_NEO4J_CONTAINER: "1"

      - name: Regression web E2E (Playwright + Neo4j)
        run: npx nx run regression:web-e2e
        env:
          SKIP_NEO4J_CONTAINER: "1"

      - name: Mobile typecheck
        run: npx nx run mobile:typecheck
